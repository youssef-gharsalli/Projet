-- Analyse des clients particuliers ayant effectuÃ© au moins 50 envois en septembre 2024

SELECT 
    EXTRACT(YEAR FROM p.date_envoi) AS annee,
    COUNT(p.num_colis) AS nb_envois,
    u.nom_client,
    u.prenom_client,
    p.email_expediteur,
    p.tel_expediteur,
    p.adresse_expediteur,
    p.ville_expediteur,
    p.code_postal_expediteur
FROM 
    schema_expeditions.faits_colis p
JOIN
    schema_clients.utilisateurs_web u
    ON p.email_expediteur = u.email
WHERE
    p.date_envoi >= '2024-09-01'
    AND p.date_envoi < '2024-10-01'
    AND (
        p.code_marque = 'AAA' OR p.code_marque = 'BBB'
    )
    AND p.pays_expediteur = 'FR'
    AND p.code_evenement = 'LIV'
    AND u.est_client_pro = FALSE
GROUP BY
    EXTRACT(YEAR FROM p.date_envoi),
    u.nom_client,
    u.prenom_client,
    p.email_expediteur,
    p.tel_expediteur,
    p.adresse_expediteur,
    p.ville_expediteur,
    p.code_postal_expediteur
HAVING 
    COUNT(p.num_colis) >= 50
;
